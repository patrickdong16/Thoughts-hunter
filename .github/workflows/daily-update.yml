name: Daily Content Update

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š4ç‚¹è¿è¡Œ (UTC 20:00å‰ä¸€å¤©)
    - cron: '0 20 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      target_date:
        description: 'ç›®æ ‡æ—¥æœŸ (YYYY-MM-DD)ï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å¤©'
        required: false
        default: ''
        type: string

jobs:
  update-content:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger daily content fetch
        run: |
          echo "ğŸš€ Triggering content update at $(date)"
          
          # è°ƒç”¨åç«¯APIæ£€æŸ¥æ‰€æœ‰æ´»è·ƒæ¥æºçš„æ–°å†…å®¹
          response=$(curl -s -X POST https://thoughts-radar-backend-production.up.railway.app/api/collection/check-all \
            -H "Content-Type: application/json" \
            --max-time 300)
          
          echo "ğŸ“¥ API Response: $response"
          echo "âœ… Content collection completed"

      - name: Auto-generate daily content (video sources)
        id: generate
        run: |
          echo "ğŸ¤– Triggering auto-content generation..."
          
          # æ„å»ºæ—¥æœŸå‚æ•°
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DATE_PARAM=""
          if [ -n "$TARGET_DATE" ]; then
            DATE_PARAM="?date=$TARGET_DATE"
            echo "ğŸ“… Using target date: $TARGET_DATE"
          else
            echo "ğŸ“… Using current date"
          fi
          
          # è°ƒç”¨åç«¯APIè‡ªåŠ¨ç­›é€‰ã€åˆ†æå’Œå‘å¸ƒè§†é¢‘å†…å®¹
          # æ³¨æ„ï¼šæ™®é€šæ—¥æœ€å¤š2æ¡è§†é¢‘ï¼Œä¸»é¢˜æ—¥ä¸é™
          generate_response=$(curl -s -X POST "https://thoughts-radar-backend-production.up.railway.app/api/automation/generate-daily${DATE_PARAM}" \
            -H "Content-Type: application/json" \
            --max-time 900)
          
          echo "ğŸ“ Generate Response: $generate_response"
          
          # æå–å‘å¸ƒæ•°é‡
          published=$(echo "$generate_response" | jq -r '.results.published // 0')
          echo "published=$published" >> $GITHUB_OUTPUT
          echo "âœ… Auto-generation completed: $published items published"

      - name: Check content gap
        id: gap
        run: |
          echo "ğŸ“Š Checking content gap..."
          
          # æ„å»ºæ—¥æœŸå‚æ•°
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DATE_PARAM=""
          if [ -n "$TARGET_DATE" ]; then
            DATE_PARAM="?date=$TARGET_DATE"
          fi
          
          # æ£€æŸ¥ä»Šæ—¥å†…å®¹ç¼ºå£
          gap_response=$(curl -s "https://thoughts-radar-backend-production.up.railway.app/api/automation/content-gap${DATE_PARAM}" \
            --max-time 30)
          
          echo "Gap Response: $gap_response"
          
          gap=$(echo "$gap_response" | jq -r '.gap // 0')
          needs_more=$(echo "$gap_response" | jq -r '.needsMore // false')
          
          echo "gap=$gap" >> $GITHUB_OUTPUT
          echo "needs_more=$needs_more" >> $GITHUB_OUTPUT
          
          if [ "$needs_more" = "true" ]; then
            echo "âš ï¸ Content gap detected: need $gap more items"
          else
            echo "âœ… Content quota met for today"
          fi

      - name: RSS Fallback (if gap remains)
        if: steps.gap.outputs.needs_more == 'true'
        run: |
          echo "ğŸ”„ Content gap detected, triggering RSS fallback..."
          
          # æ„å»ºæ—¥æœŸå‚æ•°
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DATE_PARAM=""
          if [ -n "$TARGET_DATE" ]; then
            DATE_PARAM="?date=$TARGET_DATE"
          fi
          
          # è°ƒç”¨æ€æƒ³é¢†è¢– RSS fallback å†…å®¹ç”Ÿæˆ
          fallback_response=$(curl -s -X POST "https://thoughts-radar-backend-production.up.railway.app/api/automation/generate-from-leaders${DATE_PARAM}" \
            -H "Content-Type: application/json" \
            --max-time 300)
          
          echo "ğŸ“° Fallback Response: $fallback_response"
          
          inserted=$(echo "$fallback_response" | jq -r '.results.inserted // 0')
          echo "âœ… RSS Fallback completed: $inserted items inserted"

      - name: Send push notifications
        run: |
          echo "ğŸ“² Sending push notifications..."
          
          # è°ƒç”¨åç«¯APIå‘é€æ¯æ—¥æ¨é€
          push_response=$(curl -s -X POST https://thoughts-radar-backend-production.up.railway.app/api/push/send-daily \
            -H "Content-Type: application/json" \
            --max-time 60)
          
          echo "ğŸ“¤ Push Response: $push_response"
          echo "âœ… Push notifications sent"

      - name: Send daily operations report
        run: |
          echo "ğŸ“Š Sending daily operations report..."
          
          # è°ƒç”¨åç«¯APIå‘é€æ¯æ—¥è¿è¥æŠ¥å‘Šé‚®ä»¶
          report_response=$(curl -s -X POST https://thoughts-radar-backend-production.up.railway.app/api/report/send-daily \
            -H "Content-Type: application/json" \
            --max-time 120)
          
          echo "ğŸ“§ Report Response: $report_response"
          echo "âœ… Daily report sent"

      - name: Summary
        run: |
          echo "ğŸ“‹ Daily Update Summary"
          echo "========================"
          echo "Published items: ${{ steps.generate.outputs.published }}"
          echo "Content gap: ${{ steps.gap.outputs.gap }}"
          echo "Needs more content: ${{ steps.gap.outputs.needs_more }}"

