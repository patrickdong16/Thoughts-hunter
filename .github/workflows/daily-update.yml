name: Daily Content Update

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š4ç‚¹è¿è¡Œ (UTC 20:00å‰ä¸€å¤©)
    - cron: '0 20 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      target_date:
        description: 'ç›®æ ‡æ—¥æœŸ (YYYY-MM-DD)ï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å¤©'
        required: false
        default: ''
        type: string

jobs:
  update-content:
    runs-on: ubuntu-latest
    
    steps:
      # =====================================================
      # Step 1: P0 - æ€æƒ³é¢†è¢– RSS/åšå®¢ä¼˜å…ˆé‡‡é›†
      # =====================================================
      - name: P0 - Collect from thought leaders (RSS/Blog)
        id: p0_rss
        run: |
          echo "ï¿½ P0: Starting RSS/Blog collection from thought leaders..."
          
          # æ„å»ºæ—¥æœŸå‚æ•°
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DATE_PARAM=""
          if [ -n "$TARGET_DATE" ]; then
            DATE_PARAM="?date=$TARGET_DATE"
            echo "ğŸ“… Using target date: $TARGET_DATE"
          else
            echo "ğŸ“… Using current date"
          fi
          
          # è°ƒç”¨æ€æƒ³é¢†è¢– RSS å†…å®¹é‡‡é›†
          rss_response=$(curl -s -X POST "https://thoughts-radar-backend-production.up.railway.app/api/automation/generate-from-leaders${DATE_PARAM}" \
            -H "Content-Type: application/json" \
            --max-time 300)
          
          echo "ï¿½ P0 RSS Response: $rss_response"
          
          inserted=$(echo "$rss_response" | jq -r '.results.inserted // 0')
          echo "p0_inserted=$inserted" >> $GITHUB_OUTPUT
          echo "âœ… P0 completed: $inserted items from RSS/Blog"

      # =====================================================
      # Step 2: æ£€æŸ¥éè§†é¢‘é…é¢ï¼ˆ5-7æ¡ï¼‰
      # =====================================================
      - name: Check non-video quota
        id: quota_check
        run: |
          echo "ğŸ“Š Checking content gap after P0/P1..."
          
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DATE_PARAM=""
          if [ -n "$TARGET_DATE" ]; then
            DATE_PARAM="?date=$TARGET_DATE"
          fi
          
          gap_response=$(curl -s "https://thoughts-radar-backend-production.up.railway.app/api/automation/content-gap${DATE_PARAM}" \
            --max-time 30)
          
          echo "Gap Response: $gap_response"
          
          # è§£æè¯¦ç»†ç»Ÿè®¡
          non_video_count=$(echo "$gap_response" | jq -r '.stats.nonVideo.count // 0')
          non_video_gap=$(echo "$gap_response" | jq -r '.stats.nonVideo.gap // 0')
          video_gap=$(echo "$gap_response" | jq -r '.stats.video.gap // 0')
          freq_missing=$(echo "$gap_response" | jq -r '.stats.frequency.missing | length // 0')
          
          echo "non_video_count=$non_video_count" >> $GITHUB_OUTPUT
          echo "non_video_gap=$non_video_gap" >> $GITHUB_OUTPUT
          echo "video_gap=$video_gap" >> $GITHUB_OUTPUT
          echo "freq_missing=$freq_missing" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Non-video: $non_video_count (gap: $non_video_gap)"
          echo "ğŸ“Š Video gap: $video_gap"
          echo "ğŸ“Š Missing frequencies: $freq_missing"

      # =====================================================
      # Step 3: P2 - YouTube è§†é¢‘é‡‡é›†ï¼ˆé…é¢è‡³å°‘1æ¡ï¼‰
      # =====================================================
      - name: P2 - Collect from YouTube
        id: p2_youtube
        run: |
          echo "ğŸ¬ P2: Starting YouTube collection..."
          
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DATE_PARAM=""
          if [ -n "$TARGET_DATE" ]; then
            DATE_PARAM="?date=$TARGET_DATE"
          fi
          
          # è°ƒç”¨è§†é¢‘å†…å®¹ç”Ÿæˆ
          generate_response=$(curl -s -X POST "https://thoughts-radar-backend-production.up.railway.app/api/automation/generate-daily${DATE_PARAM}" \
            -H "Content-Type: application/json" \
            --max-time 900)
          
          echo "ğŸ¬ P2 YouTube Response: $generate_response"
          
          published=$(echo "$generate_response" | jq -r '.results.published // 0')
          echo "p2_published=$published" >> $GITHUB_OUTPUT
          echo "âœ… P2 completed: $published video items"

      # =====================================================
      # Step 4: æœ€ç»ˆé…é¢æ£€æŸ¥
      # =====================================================
      - name: Final quota check
        id: final_check
        run: |
          echo "ğŸ“Š Final content status check..."
          
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DATE_PARAM=""
          if [ -n "$TARGET_DATE" ]; then
            DATE_PARAM="?date=$TARGET_DATE"
          fi
          
          gap_response=$(curl -s "https://thoughts-radar-backend-production.up.railway.app/api/automation/content-gap${DATE_PARAM}" \
            --max-time 30)
          
          echo "Final Gap Response: $gap_response"
          
          current=$(echo "$gap_response" | jq -r '.currentCount // 0')
          min=$(echo "$gap_response" | jq -r '.minItems // 6')
          gap=$(echo "$gap_response" | jq -r '.gap // 0')
          
          if [ "$gap" -eq 0 ]; then
            echo "âœ… Content quota met: $current items (min: $min)"
          else
            echo "âš ï¸ Content gap remains: $gap items short ($current/$min)"
          fi
          
          echo "final_count=$current" >> $GITHUB_OUTPUT
          echo "final_gap=$gap" >> $GITHUB_OUTPUT

      - name: Send push notifications
        run: |
          echo "ğŸ“² Sending push notifications..."
          
          # è°ƒç”¨åç«¯APIå‘é€æ¯æ—¥æ¨é€
          push_response=$(curl -s -X POST https://thoughts-radar-backend-production.up.railway.app/api/push/send-daily \
            -H "Content-Type: application/json" \
            --max-time 60)
          
          echo "ğŸ“¤ Push Response: $push_response"
          echo "âœ… Push notifications sent"

      - name: Send daily operations report
        run: |
          echo "ğŸ“Š Sending daily operations report..."
          
          # è°ƒç”¨åç«¯APIå‘é€æ¯æ—¥è¿è¥æŠ¥å‘Šé‚®ä»¶
          report_response=$(curl -s -X POST https://thoughts-radar-backend-production.up.railway.app/api/report/send-daily \
            -H "Content-Type: application/json" \
            --max-time 120)
          
          echo "ğŸ“§ Report Response: $report_response"
          echo "âœ… Daily report sent"

      - name: Summary
        run: |
          echo "ğŸ“‹ Daily Update Summary"
          echo "========================"
          echo "P0 RSS items: ${{ steps.p0_rss.outputs.p0_inserted }}"
          echo "P2 Video items: ${{ steps.p2_youtube.outputs.p2_published }}"
          echo "Final count: ${{ steps.final_check.outputs.final_count }}"
          echo "Final gap: ${{ steps.final_check.outputs.final_gap }}"

