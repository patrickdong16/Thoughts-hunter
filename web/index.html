<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>æ€æƒ³é›·è¾¾ - Thoughts Radar</title>
  <style>
    :root {
      /* ä¸»é¢˜è‰² - å®Œå…¨åŒ¹é…ç§»åŠ¨ç«¯è®¾è®¡ */
      --primary: #00ff88;
      --background: #08090c;
      --card: #12151a;
      --card-hover: #1a1d24;
      --card-border: rgba(0, 255, 136, 0.1);

      /* æ–‡æœ¬ */
      --text: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;

      /* è¾¹æ¡† */
      --border: #1f2937;
      --border-light: #374151;

      /* ç«‹åœºé¢œè‰² */
      --side-a: #4a9eff;
      --side-b: #f0a500;

      /* çŠ¶æ€ */
      --success: #00ff88;
      --warning: #f59e0b;
      --error: #ef4444;

      /* é¢†åŸŸé¢œè‰² */
      --domain-tech: #4a9eff;
      --domain-politics: #ef4444;
      --domain-history: #8b5cf6;
      --domain-philosophy: #ec4899;
      --domain-religion: #f59e0b;
      --domain-finance: #10b981;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* === å¤´éƒ¨ === */
    header {
      background: var(--background);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-size: 32px;
    }

    .title-group h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.2;
    }

    .title-group .subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .title-group .slogan {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 32px;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .delete-btn {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .delete-btn:hover {
      opacity: 1;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .date {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .refresh-btn {
      font-size: 12px;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .refresh-btn:active {
      background: rgba(0, 255, 136, 0.1);
      color: var(--primary);
    }

    /* === è¿‡æ»¤å™¨ === */
    .filters-container {
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .filters-container::-webkit-scrollbar {
      display: none;
    }

    .filters {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      min-width: max-content;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-btn:hover {
      border-color: var(--border-light);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--background);
      font-weight: 700;
    }

    /* === ä¸»å†…å®¹åŒº === */
    main {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 80px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* === é›·è¾¾å¡ç‰‡ === */
    .radar-list {
      padding: 16px;
    }

    .radar-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--card-border);
    }

    /* æ ‡ç­¾åŒº */
    .card-tags {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tag {
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid;
    }

    /* æ ‡é¢˜ */
    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    /* ä½œè€…ä¿¡æ¯ */
    .author-info {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .author-avatar {
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      border-radius: 50%;
      background: rgba(0, 255, 136, 0.1);
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
      overflow: hidden;
      flex-shrink: 0;
    }

    .author-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    .author-bio {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* æ¥æº */
    .source-line {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .source-bar {
      width: 3px;
      height: 100%;
      min-height: 16px;
      background: var(--primary);
      margin-right: 8px;
      border-radius: 2px;
    }

    .source-text {
      font-size: 13px;
      color: var(--primary);
    }

    /* æ­£æ–‡å†…å®¹ */
    .card-content-first {
      font-size: 15px;
      color: var(--text);
      line-height: 1.8;
      margin-bottom: 12px;
    }

    .card-content-first p {
      margin-bottom: 12px;
    }

    .card-content-rest {
      font-size: 15px;
      color: var(--text);
      line-height: 1.8;
      margin-bottom: 12px;
      max-height: none;
      opacity: 1;
      transition: all 0.3s ease;
    }

    .card-content-rest.collapsed {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      margin-bottom: 0;
    }

    .card-content-rest p {
      margin-bottom: 12px;
    }

    .expand-btn {
      font-size: 13px;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      margin-top: 8px;
      margin-bottom: 20px;
      display: inline-block;
      padding: 8px 0;
    }

    /* å¼ åŠ›ä¿¡æ¯åŒº */
    .tension-box {
      background: var(--background);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      margin-bottom: 12px;
    }

    .tension-question {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 8px;
    }

    .tension-poles {
      display: flex;
      gap: 12px;
    }

    .pole {
      flex: 1;
    }

    .pole-label {
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .pole-label.side-a {
      color: var(--side-a);
    }

    .pole-label.side-b {
      color: var(--side-b);
    }

    .pole-text {
      font-size: 13px;
      color: var(--text);
    }

    .pole-divider {
      width: 1px;
      background: var(--border);
    }

    /* å…³é”®è¯ */
    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }

    .keyword-tag {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      background: rgba(0, 255, 136, 0.1);
      color: var(--primary);
      border: 1px solid rgba(0, 255, 136, 0.2);
    }

    /* åº•éƒ¨æ“ä½œæ  */
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .card-tags-bottom {
      display: flex;
      gap: 6px;
    }

    .like-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      margin: -8px;
    }

    .like-icon {
      font-size: 20px;
    }

    .like-text {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .like-btn.active .like-text {
      color: var(--error);
      font-weight: 500;
    }

    .stance-buttons {
      display: flex;
      gap: 8px;
    }

    .stance-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .stance-btn.side-a:hover {
      border-color: var(--side-a);
      color: var(--side-a);
    }

    .stance-btn.side-b:hover {
      border-color: var(--side-b);
      color: var(--side-b);
    }

    .stance-btn.side-a.active {
      background: var(--side-a);
      border-color: var(--side-a);
      color: var(--text);
      font-weight: 600;
    }

    .stance-btn.side-b.active {
      background: var(--side-b);
      border-color: var(--side-b);
      color: var(--text);
      font-weight: 600;
    }

    /* === æŠ•ç¥¨åŒº - æç®€è®¾è®¡ === */
    .vote-section {
      background: var(--background);
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
      margin-bottom: 16px;
    }

    .vote-question {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      font-weight: 500;
    }

    .vote-options {
      display: flex;
      gap: 12px;
    }

    .vote-option {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .vote-option:hover {
      border-color: var(--primary);
      background: rgba(0, 255, 136, 0.05);
    }

    .vote-option.selected {
      border-color: var(--primary);
      background: rgba(0, 255, 136, 0.1);
    }

    .vote-radio {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--border);
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .vote-radio.active {
      border-color: var(--primary);
      background: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.2);
    }

    .vote-label {
      font-size: 13px;
      color: var(--text);
      flex: 1;
      text-align: left;
    }

    /* === TTI é¡µé¢ === */
    .tti-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
    }

    .tti-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--card-border);
    }

    .tti-emoji {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .tti-name {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 4px;
    }

    .tti-value {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--side-a), var(--side-b));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .spectrum-bar {
      height: 6px;
      background: linear-gradient(90deg, var(--side-a), var(--side-b));
      border-radius: 3px;
      margin-top: 12px;
      position: relative;
    }

    .spectrum-indicator {
      position: absolute;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      top: -4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: left 0.3s;
    }

    /* === ä¸ªäººé¡µé¢ === */
    .profile-tabs {
      display: flex;
      gap: 8px;
      padding: 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .profile-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 15px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-tab.active {
      background: var(--primary);
      color: var(--surface);
    }

    .profile-content {
      display: none;
      padding: 16px;
    }

    .profile-content.active {
      display: block;
    }

    .profile-section {
      padding: 20px;
      background: var(--background);
      border-radius: 12px;
      margin: 16px;
    }

    .profile-section h3 {
      font-size: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--card-border);
    }

    .profile-section h3 {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
    }

    .profile-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .profile-item:last-child {
      border-bottom: none;
    }

    /* === ç»Ÿè®¡æ  === */
    .stats-bar {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 8px 16px;
      text-align: center;
      z-index: 50;
    }

    .stats-text {
      font-size: 13px;
      color: var(--primary);
      font-weight: 500;
    }

    /* === Tab Bar === */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      display: flex;
      border-top: 1px solid var(--border);
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .tab-item {
      flex: 1;
      text-align: center;
      padding: 12px 8px 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .tab-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 40px;
      height: 3px;
      background: var(--primary);
      border-radius: 0 0 3px 3px;
      transition: transform 0.3s ease;
    }

    .tab-item.active::before {
      transform: translateX(-50%) scaleX(1);
    }

    .tab-item.active {
      color: var(--primary);
    }

    .tab-item .icon {
      font-size: 22px;
      margin-bottom: 4px;
      transition: transform 0.2s ease;
    }

    .tab-item.active .icon {
      transform: scale(1.1);
    }

    .tab-item .label {
      font-size: 11px;
      font-weight: 500;
    }

    .tab-item.active .label {
      font-weight: 600;
    }

    /* === åŠ è½½çŠ¶æ€ === */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* === å†å²é¡µé¢ === */
    .date-picker {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      overflow-x: auto;
      border-bottom: 1px solid var(--border);
    }

    .date-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .date-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--background);
    }
  </style>
</head>

<body>
  <!-- å¤´éƒ¨ -->
  <header>
    <div class="header-left">
      <span class="logo">ğŸ“¡</span>
      <div class="title-group">
        <h1>æ€æƒ³é›·è¾¾</h1>
        <div class="subtitle">Thoughts Radar</div>
        <div class="slogan">è¿æ¥æ·±é‚‚æ€æƒ³ï¼Œå…³æ³¨æ—¶ä»£é—®é¢˜</div>
      </div>
    </div>
    <div class="header-right">
      <div class="date" id="current-date"></div>
      <button class="refresh-btn" id="refresh-btn" onclick="refreshCurrentPage()" style="display:none;">
        ğŸ”„ åˆ·æ–°
      </button>
    </div>
  </header>

  <!-- è¿‡æ»¤å™¨ï¼ˆä»…ä»Šæ—¥é¡µé¢æ˜¾ç¤ºï¼‰ -->
  <div class="filters-container" id="filters-container">
    <div class="filters">
      <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
      <button class="filter-btn" data-filter="tech">ğŸ”¬ ç§‘æŠ€</button>
      <button class="filter-btn" data-filter="politics">ğŸ›ï¸ æ”¿æ²»</button>
      <button class="filter-btn" data-filter="history">ğŸ“š å†å²</button>
      <button class="filter-btn" data-filter="philosophy">ğŸ¤” å“²å­¦</button>
      <button class="filter-btn" data-filter="religion">â›ª å®—æ•™</button>
      <button class="filter-btn" data-filter="finance">ğŸ’° é‡‘è</button>
    </div>
  </div>

  <main>
    <!-- ä»Šæ—¥é›·è¾¾ -->
    <div id="today" class="tab-content active">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- å¼ åŠ›æŒ‡æ•° -->
    <div id="tti" class="tab-content">
      <div
        style="padding: 16px; background: var(--background); margin: 16px; border-radius: 12px; border: 1px solid var(--border);">
        <h3 style="font-size: 14px; color: var(--primary); margin-bottom: 8px; font-weight: 600;">ğŸ“Š ä»€ä¹ˆæ˜¯æ€æƒ³å¼ åŠ›æŒ‡æ•° (TTI)?
        </h3>
        <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 8px;">
          TTI è¡¡é‡æŸä¸ªè®®é¢˜ä¸¤æè§‚ç‚¹çš„å¯¹ç«‹ç¨‹åº¦ã€‚æ•°å€¼ 0-100ï¼Œ50 è¡¨ç¤ºå‡è¡¡ï¼Œè¶Šæ¥è¿‘ä¸¤ç«¯è¡¨ç¤ºæŸä¸€æ–¹è§‚ç‚¹è¶Šå ä¸»å¯¼ã€‚
        </p>
        <p style="font-size: 12px; color: var(--text-muted); line-height: 1.5;">
          æ•°æ®æ¥æºï¼šåŸºäºæœ¬ APP ç”¨æˆ·çš„ç«‹åœºé€‰æ‹©ç»Ÿè®¡ï¼Œæ¯æ¬¡ç”¨æˆ·è¡¨è¾¾å€¾å‘åå®æ—¶æ›´æ–°ã€‚åæ˜ çš„æ˜¯ä½¿ç”¨æœ¬åº”ç”¨çš„ç”¨æˆ·ç¾¤ä½“çš„è§‚ç‚¹åˆ†å¸ƒã€‚
        </p>
      </div>
      <div class="tti-grid" id="tti-grid"></div>
    </div>

    <!-- å†å² -->
    <div id="history" class="tab-content">
      <div class="date-picker" id="date-picker"></div>
      <div id="history-content" class="radar-list"></div>
    </div>

    <!-- æˆ‘çš„ -->
    <div id="profile" class="tab-content">
      <!-- å­æ ‡ç­¾ -->
      <div class="profile-tabs">
        <button class="profile-tab active" data-type="likes">â¤ï¸ æˆ‘çš„æ”¶è—</button>
        <button class="profile-tab" data-type="stances">ğŸ¯ æˆ‘çš„ç«‹åœº</button>
      </div>

      <!-- æ”¶è—åˆ—è¡¨ -->
      <div id="profile-likes" class="profile-content active">
        <div id="my-likes" class="empty-state">æš‚æ— æ”¶è—</div>
      </div>

      <!-- ç«‹åœºåˆ—è¡¨ -->
      <div id="profile-stances" class="profile-content">
        <div id="my-stances" class="empty-state">æš‚æ— ç«‹åœº</div>
      </div>
    </div>
  </main>

  <!-- ç»Ÿè®¡æ  -->
  <div class="stats-bar" id="stats-bar" style="display:none;">
    <span class="stats-text" id="stats-text"></span>
  </div>

  <!-- Tab Bar -->
  <nav class="tab-bar">
    <div class="tab-item active" data-tab="today">
      <div class="icon">ğŸ“¡</div>
      <div class="label">ä»Šæ—¥</div>
    </div>
    <!-- TTI æš‚æ—¶éšè—ï¼Œç­‰å¾…æ•°æ®ç§¯ç´¯
    <div class="tab-item" data-tab="tti">
      <div class="icon">ğŸ“Š</div>
      <div class="label">å¼ åŠ›</div>
    </div>
    -->
    <div class="tab-item" data-tab="history">
      <div class="icon">ğŸ“š</div>
      <div class="label">å¾€æœŸ</div>
    </div>
    <div class="tab-item" data-tab="profile">
      <div class="icon">ğŸ‘¤</div>
      <div class="label">æˆ‘çš„</div>
    </div>
  </nav>

  <script>
    // API é…ç½® - è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000'
      : (window.API_URL || 'https://thoughts-radar-backend-production.up.railway.app');
    const USER_ID = localStorage.getItem('user_id') || 'web-user-' + Date.now();
    if (!localStorage.getItem('user_id')) {
      localStorage.setItem('user_id', USER_ID);
    }

    const userLikes = new Set(JSON.parse(localStorage.getItem('userLikes') || '[]'));
    const userStances = JSON.parse(localStorage.getItem('userStances') || '{}');
    let allItems = [];
    let currentFilter = 'all';
    const scrollPositions = {}; // è®°å½•æ¯ä¸ªæ ‡ç­¾é¡µçš„æ»šåŠ¨ä½ç½®

    // é¢†åŸŸé…ç½®
    const DOMAIN_CONFIG = {
      tech: { label: 'ç§‘æŠ€', color: '#4a9eff', icon: 'ğŸ”¬' },
      politics: { label: 'æ”¿æ²»', color: '#ef4444', icon: 'ğŸ›ï¸' },
      history: { label: 'å†å²', color: '#8b5cf6', icon: 'ğŸ“š' },
      philosophy: { label: 'å“²å­¦', color: '#ec4899', icon: 'ğŸ¤”' },
      religion: { label: 'å®—æ•™', color: '#f59e0b', icon: 'â›ª' },
      finance: { label: 'é‡‘è', color: '#10b981', icon: 'ğŸ’°' }
    };

    // è®¾ç½®å½“å‰æ—¥æœŸ
    function setCurrentDate() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      document.getElementById('current-date').textContent = `${y}.${m}.${d}`;
    }

    // Tab åˆ‡æ¢
    document.querySelectorAll('.tab-item').forEach(tab => {
      tab.addEventListener('click', () => {
        const currentTab = document.querySelector('.tab-item.active')?.dataset.tab;
        const tabName = tab.dataset.tab;

        // ä¿å­˜å½“å‰æ ‡ç­¾é¡µçš„æ»šåŠ¨ä½ç½®
        if (currentTab) {
          scrollPositions[currentTab] = window.scrollY;
        }

        // æ›´æ–° tab çŠ¶æ€
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tabName).classList.add('active');

        // æ˜¾ç¤º/éšè—è¿‡æ»¤å™¨
        document.getElementById('filters-container').style.display =
          tabName === 'today' ? 'block' : 'none';

        // æ˜¾ç¤º/éšè—ç»Ÿè®¡æ 
        document.getElementById('stats-bar').style.display =
          tabName === 'today' && allItems.length > 0 ? 'block' : 'none';

        // åŠ è½½ç›¸åº”å†…å®¹
        if (tabName === 'tti') loadTTI();
        if (tabName === 'profile') loadProfile();
        if (tabName === 'history') loadHistory();

        // æ¢å¤è¯¥æ ‡ç­¾é¡µçš„æ»šåŠ¨ä½ç½®
        setTimeout(() => {
          window.scrollTo(0, scrollPositions[tabName] || 0);
        }, 100);
      });
    });

    // è¿‡æ»¤å™¨åˆ‡æ¢
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderItems();
      });
    });

    // æ ¼å¼åŒ–æ­£æ–‡å†…å®¹ - æ™ºèƒ½åˆ†æ®µ
    function formatContent(content) {
      if (!content) return '';

      // æŒ‰å¥å·åˆ†æ®µï¼Œä¿ç•™åŸæœ‰çš„æ¢è¡Œ
      const paragraphs = content.split('\n').filter(p => p.trim());

      if (paragraphs.length > 1) {
        // å·²æœ‰æ®µè½ï¼Œç›´æ¥ç”¨ <p> åŒ…è£…
        return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
      }

      // å•æ®µæ–‡æœ¬ï¼ŒæŒ‰å¥å·æ™ºèƒ½åˆ†æ®µ
      const sentences = content.split(/([ã€‚ï¼ï¼Ÿ])/);
      let formatted = '';
      let current = '';

      for (let i = 0; i < sentences.length; i += 2) {
        const sentence = sentences[i] + (sentences[i + 1] || '');
        current += sentence;

        // æ¯2-3å¥ä¸€æ®µ
        if ((i / 2 + 1) % 2 === 0 || i >= sentences.length - 2) {
          if (current.trim()) {
            formatted += `<p>${current.trim()}</p>`;
            current = '';
          }
        }
      }

      return formatted || `<p>${content}</p>`;
    }

    // æ ¼å¼åŒ–å†…å®¹å¹¶åˆ†ç¦»ç¬¬ä¸€æ®µ
    function formatContentWithFirstPara(content) {
      if (!content) return { first: '', rest: '' };

      const paragraphs = content.split('\n').filter(p => p.trim());

      if (paragraphs.length > 1) {
        const first = `<p>${paragraphs[0].trim()}</p>`;
        const rest = paragraphs.slice(1).map(p => `<p>${p.trim()}</p>`).join('');
        return { first, rest, hasMore: rest.length > 0 };
      }

      // å•æ®µæ–‡æœ¬ï¼ŒæŒ‰å¥å·åˆ†æ®µ
      const sentences = content.split(/([ã€‚ï¼ï¼Ÿ])/);
      const allParas = [];
      let current = '';

      for (let i = 0; i < sentences.length; i += 2) {
        const sentence = sentences[i] + (sentences[i + 1] || '');
        current += sentence;

        if ((i / 2 + 1) % 2 === 0 || i >= sentences.length - 2) {
          if (current.trim()) {
            allParas.push(`<p>${current.trim()}</p>`);
            current = '';
          }
        }
      }

      if (allParas.length === 0) {
        return { first: `<p>${content}</p>`, rest: '', hasMore: false };
      }

      const first = allParas[0];
      const rest = allParas.slice(1).join('');
      return { first, rest, hasMore: rest.length > 0 };
    }

    // æ¸²æŸ“é›·è¾¾å¡ç‰‡
    function renderRadarCard(item) {
      const domain = DOMAIN_CONFIG[item.domain] || { label: item.domain, color: '#6b7280', icon: 'ğŸ“' };
      const isLiked = userLikes.has(item.id);
      const userStance = userStances[item.id];

      // ä½¿ç”¨æ–°çš„åˆ†æ®µé€»è¾‘
      const contentParts = formatContentWithFirstPara(item.content);
      const hasMoreContent = contentParts.hasMore;

      return `
        <div class="radar-card" data-id="${item.id}">
          <!-- æ ‡é¢˜ -->
          <div class="card-title">${item.title}</div>
          
          <!-- ä½œè€…ä¿¡æ¯ -->
          ${item.author_name ? `
          <div class="author-info">
            <div class="author-avatar">${item.author_avatar || item.author_name.substring(0, 2)}</div>
            <div>
              <div class="author-name">${item.author_name}</div>
              ${item.author_bio ? `<div class="author-bio">${item.author_bio}</div>` : ''}
            </div>
          </div>
          ` : ''}
          
          <!-- æ¥æº -->
          ${item.source ? `
          <div class="source-line">
            <div class="source-bar"></div>
            <span class="source-text">${item.source}</span>
          </div>
          ` : ''}
          
          <!-- æ­£æ–‡ç¬¬ä¸€æ®µ -->
          <div class="card-content-first">
            ${contentParts.first}
          </div>
          
          <!-- å‰©ä½™å†…å®¹ï¼ˆå¯æŠ˜å ï¼‰ -->
          ${hasMoreContent ? `
          <div class="card-content-rest collapsed" id="content-rest-${item.id}">
            ${contentParts.rest}
          </div>
          <div class="expand-btn" onclick="toggleExpand(${item.id})">å±•å¼€å…¨æ–‡ â†“</div>
          ` : ''}
          
          <!-- å¼ åŠ›ä¿¡æ¯ -->
          <div class="tension-box">
            <div class="tension-question">${item.tension_q || item.band_question || 'æ ¸å¿ƒå¼ åŠ›'}</div>
            <div class="tension-poles">
              <div class="pole">
                <div class="pole-label side-a">Aæ</div>
                <div class="pole-text">${item.tension_a || item.band_side_a || 'è§‚ç‚¹A'}</div>
              </div>
              <div class="pole-divider"></div>
              <div class="pole">
                <div class="pole-label side-b">Bæ</div>
                <div class="pole-text">${item.tension_b || item.band_side_b || 'è§‚ç‚¹B'}</div>
              </div>
            </div>
          </div>
          
          <!-- æŠ•ç¥¨åŒº - æç®€è®¾è®¡ -->
          <div class="vote-section">
            <div class="vote-question">æ‚¨çš„è§‚ç‚¹ï¼Ÿ</div>
            <div class="vote-options">
              <button class="vote-option ${userStance === 'A' ? 'selected' : ''}" 
                      data-side="A"
                      onclick="setStance(${item.id}, 'A', this)">
                <span class="vote-radio ${userStance === 'A' ? 'active' : ''}"></span>
                <span class="vote-label">A: ${(item.tension_a || item.band_side_a || 'è§‚ç‚¹A').substring(0, 12)}...</span>
              </button>
              <button class="vote-option ${userStance === 'B' ? 'selected' : ''}"
                      data-side="B"
                      onclick="setStance(${item.id}, 'B', this)">
                <span class="vote-radio ${userStance === 'B' ? 'active' : ''}"></span>
                <span class="vote-label">B: ${(item.tension_b || item.band_side_b || 'è§‚ç‚¹B').substring(0, 12)}...</span>
              </button>
            </div>
          </div>
          
          <!-- åº•éƒ¨åŒºåŸŸï¼šæ”¶è— + æ ‡ç­¾ -->
          <div class="card-footer">
            <button class="like-btn ${isLiked ? 'active' : ''}" onclick="toggleLike(${item.id}, this)">
              <span class="like-icon">${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
              <span class="like-text">æ”¶è—</span>
            </button>
            
            <div class="card-tags-bottom">
              <span class="tag" style="background:${domain.color}20; border-color:${domain.color}; color:${domain.color}">
                ${domain.icon} ${domain.label}
              </span>
            </div>
          </div>
          
          <!-- å…³é”®è¯ -->
          ${(item.keywords && item.keywords.length > 0) ? `
          <div class="keywords">
            ${item.keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
          </div>
          ` : ''}
        </div>
      `;
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderItems() {
      const container = document.getElementById('today');
      let filtered = allItems;

      if (currentFilter !== 'all') {
        filtered = allItems.filter(item => item.domain === currentFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="loading">
            <span style="font-size:64px;margin-bottom:16px">ğŸ“­</span>
            <div style="font-size:17px;font-weight:600;margin-bottom:8px">
              ${allItems.length === 0 ? 'ä»Šæ—¥æš‚æ— å†…å®¹' : 'è¯¥é¢†åŸŸæš‚æ— å†…å®¹'}
            </div>
            <div style="font-size:13px;color:#6b7280">ä¸‹æ‹‰åˆ·æ–°æŸ¥çœ‹æœ€æ–°å†…å®¹</div>
          </div>
        `;
        document.getElementById('stats-bar').style.display = 'none';
      } else {
        container.innerHTML = `<div class="radar-list">${filtered.map(renderRadarCard).join('')}</div>`;
        document.getElementById('stats-bar').style.display = 'block';
        const domainLabel = currentFilter !== 'all' ? DOMAIN_CONFIG[currentFilter]?.label : '';
        document.getElementById('stats-text').textContent = `ä»Šæ—¥${domainLabel}å…±${filtered.length}æ¡`;
      }
    }

    // å±•å¼€/æ”¶èµ·
    window.toggleExpand = function (itemId) {
      const content = document.getElementById(`content-rest-${itemId}`);
      const btn = content.nextElementSibling;
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        btn.textContent = 'æ”¶èµ· â†‘';
      } else {
        content.classList.add('collapsed');
        btn.textContent = 'å±•å¼€å…¨æ–‡ â†“';
      }
    };

    // æ”¶è—
    window.toggleLike = async function (itemId, btn) {
      const isLiked = userLikes.has(itemId);
      try {
        await fetch(`${API_BASE}/api/user/like`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: USER_ID, item_id: itemId, liked: !isLiked })
        });

        if (isLiked) {
          userLikes.delete(itemId);
          btn.classList.remove('active');
          btn.querySelector('.like-icon').textContent = 'ğŸ¤';
        } else {
          userLikes.add(itemId);
          btn.classList.add('active');
          btn.querySelector('.like-icon').textContent = 'â¤ï¸';
        }
        localStorage.setItem('userLikes', JSON.stringify([...userLikes]));
      } catch (e) {
        console.error('Like error:', e);
      }
    };

    // ç«‹åœº
    window.setStance = async function (itemId, stance, btn) {
      const currentStance = userStances[itemId];
      const newStance = currentStance === stance ? null : stance;

      // å…ˆæ›´æ–°UIï¼ˆç«‹å³åé¦ˆï¼‰
      const card = btn.closest('.radar-card');
      const voteOptions = card.querySelectorAll('.vote-option');
      const voteRadios = card.querySelectorAll('.vote-radio');

      // å…ˆæ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
      voteOptions.forEach(opt => {
        opt.classList.remove('selected');
      });
      voteRadios.forEach(radio => {
        radio.classList.remove('active');
      });

      // å¦‚æœä¸æ˜¯å–æ¶ˆé€‰æ‹©ï¼Œæ·»åŠ æ–°é€‰ä¸­çŠ¶æ€
      if (newStance) {
        btn.classList.add('selected');
        const radio = btn.querySelector('.vote-radio');
        if (radio) {
          radio.classList.add('active');
        }
      }

      try {
        // ä¿å­˜åˆ°åç«¯
        await fetch(`${API_BASE}/api/user/stance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: USER_ID, item_id: itemId, stance: newStance })
        });

        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        if (newStance === null) {
          delete userStances[itemId];
        } else {
          userStances[itemId] = newStance;
        }
        localStorage.setItem('userStances', JSON.stringify(userStances));

        console.log('Stance updated:', itemId, newStance);

        // å¦‚æœ"æˆ‘çš„"æ ‡ç­¾é¡µæ˜¯æ¿€æ´»çš„ï¼Œé‡æ–°åŠ è½½
        const activeTab = document.querySelector('.tab-item.active');
        if (activeTab && activeTab.dataset.tab === 'profile') {
          loadProfile();
        }
      } catch (e) {
        console.error('Stance error:', e);
        // å¦‚æœä¿å­˜å¤±è´¥ï¼Œæ¢å¤ä¹‹å‰çš„UIçŠ¶æ€
        voteOptions.forEach(opt => opt.classList.remove('selected'));
        voteRadios.forEach(radio => radio.classList.remove('active'));
        if (currentStance) {
          const prevBtn = card.querySelector(`[data-side="${currentStance}"]`);
          if (prevBtn) {
            prevBtn.classList.add('selected');
            prevBtn.querySelector('.vote-radio')?.classList.add('active');
          }
        }
      }
    };

    // åŠ è½½ä»Šæ—¥æ•°æ®
    async function loadToday() {
      try {
        const res = await fetch(`${API_BASE}/api/radar/today`);
        const data = await res.json();
        allItems = data.success ? (data.items || []) : [];
        renderItems();
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('today').innerHTML = `
          <div class="loading">
            <span style="font-size:64px;margin-bottom:16px">âš ï¸</span>
            <div style="font-size:17px;font-weight:600;margin-bottom:8px">åŠ è½½å¤±è´¥</div>
            <div style="font-size:13px;color:#6b7280">${e.message}</div>
            <button onclick="loadToday()" style="margin-top:16px;padding:8px 24px;background:#00ff88;border:none;border-radius:20px;font-weight:700;cursor:pointer">é‡è¯•</button>
          </div>
        `;
      }
    }

    // åŠ è½½ TTI
    async function loadTTI() {
      try {
        const res = await fetch(`${API_BASE}/api/bands`);
        const data = await res.json();
        const bands = data.success ? (data.bands || []) : [];

        document.getElementById('tti-grid').innerHTML = bands.map(band => {
          const tti = band.tti || band.tti_index || 50;
          return `
            <div class="tti-card">
              <div class="tti-emoji">${band.emoji || 'ğŸ“Š'}</div>
              <div class="tti-name">${band.question || band.name}</div>
              <div class="tti-value">${tti}</div>
              <div class="spectrum-bar">
                <div class="spectrum-indicator" style="left:calc(${tti}% - 7px)"></div>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Load TTI error:', e);
      }
    }

    // åŠ è½½å†å²
    async function loadHistory() {
      const picker = document.getElementById('date-picker');
      const dates = [];
      // ä»æ˜¨å¤©å¼€å§‹ï¼Œä¸åŒ…æ‹¬ä»Šå¤©
      for (let i = 1; i <= 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(d.toISOString().split('T')[0]);
      }

      picker.innerHTML = dates.map((date, i) => {
        const d = new Date(date);
        const label = i === 0 ? 'æ˜¨å¤©' : i === 1 ? 'å‰å¤©' : `${d.getMonth() + 1}/${d.getDate()}`;
        return `<button class="date-btn ${i === 0 ? 'active' : ''}" data-date="${date}">${label}</button>`;
      }).join('');

      picker.querySelectorAll('.date-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          picker.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadHistoryDate(btn.dataset.date);
        });
      });

      loadHistoryDate(dates[0]);
    }

    async function loadHistoryDate(date) {
      try {
        const res = await fetch(`${API_BASE}/api/radar/${date}`);
        const data = await res.json();
        const items = data.success ? (data.items || []) : [];

        document.getElementById('history-content').innerHTML = items.length > 0
          ? items.map(renderRadarCard).join('')
          : '<div class="empty-state">è¯¥æ—¥æœŸæš‚æ— å†…å®¹</div>';
      } catch (e) {
        console.error('Load history error:', e);
      }
    }

    // åŠ è½½ä¸ªäººä¿¡æ¯
    async function loadProfile() {
      try {
        // ç›´æ¥ä»localStorageè¯»å–æœ€æ–°æ•°æ®ï¼ˆæœ€å¯é ï¼‰
        const likesDiv = document.getElementById('my-likes');
        const stancesDiv = document.getElementById('my-stances');

        // æ˜¾ç¤ºæ”¶è—ï¼ˆå¸¦åˆ é™¤æŒ‰é’®ï¼‰
        const likesList = Array.from(userLikes);
        if (likesList.length > 0) {
          likesDiv.innerHTML = likesList.map(itemId => {
            const item = allItems.find(i => i.id === itemId);
            const title = item ? item.title : 'å†…å®¹ #' + itemId;
            return `
              <div class="profile-item" onclick="scrollToItem(${itemId})">
                <div class="profile-item-content">${title}</div>
                <button class="delete-btn" onclick="event.stopPropagation(); removeLike(${itemId})">ğŸ—‘ï¸</button>
              </div>
            `;
          }).join('');
        } else {
          likesDiv.innerHTML = '<div class="empty-state">æš‚æ— æ”¶è—</div>';
        }

        // æ˜¾ç¤ºç«‹åœºï¼ˆå¸¦åˆ é™¤æŒ‰é’®ï¼‰
        const stancesList = Object.entries(userStances).filter(([_, stance]) => stance !== null);
        if (stancesList.length > 0) {
          stancesDiv.innerHTML = stancesList.map(([itemId, stance]) => {
            const item = allItems.find(i => i.id == itemId);
            const title = item ? item.title : 'å†…å®¹ #' + itemId;
            return `
              <div class="profile-item" onclick="scrollToItem(${itemId})">
                <div class="profile-item-content">
                  ${title}ï¼š
                  <span style="color:${stance === 'A' ? 'var(--side-a)' : 'var(--side-b)'}">
                    å€¾å‘${stance}
                  </span>
                </div>
                <button class="delete-btn" onclick="event.stopPropagation(); removeStance(${itemId})">ğŸ—‘ï¸</button>
              </div>
            `;
          }).join('');
        } else {
          stancesDiv.innerHTML = '<div class="empty-state">æš‚æ— ç«‹åœº</div>';
        }

        console.log('Profile loaded:', {
          likes: likesList.length,
          stances: stancesList.length
        });
      } catch (e) {
        console.error('Profile error:', e);
      }
    }

    // åˆ é™¤æ”¶è—
    window.removeLike = function (itemId) {
      userLikes.delete(itemId);
      localStorage.setItem('userLikes', JSON.stringify([...userLikes]));
      loadProfile();

      // åŒæ­¥æ›´æ–°å¡ç‰‡çº¢å¿ƒ
      const card = document.querySelector(`.radar-card[data-id="${itemId}"]`);
      if (card) {
        const likeBtn = card.querySelector('.like-btn');
        if (likeBtn) {
          likeBtn.classList.remove('active');
          likeBtn.querySelector('.like-icon').textContent = 'ğŸ¤';
        }
      }
    };

    // åˆ é™¤ç«‹åœº
    window.removeStance = function (itemId) {
      delete userStances[itemId];
      localStorage.setItem('userStances', JSON.stringify(userStances));
      loadProfile();
      // æ›´æ–°å¡ç‰‡UI
      const card = document.querySelector(`.radar-card[data-id="${itemId}"]`);
      if (card) {
        const voteOptions = card.querySelectorAll('.vote-option');
        const voteRadios = card.querySelectorAll('.vote-radio');
        voteOptions.forEach(opt => opt.classList.remove('selected'));
        voteRadios.forEach(radio => radio.classList.remove('active'));
      }
    };

    // æ»šåŠ¨åˆ°æŒ‡å®šå†…å®¹
    window.scrollToItem = function (itemId) {
      // åˆ‡æ¢åˆ°ä»Šæ—¥æ ‡ç­¾
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      document.querySelector('[data-tab="today"]').classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('today').classList.add('active');

      // æ»šåŠ¨åˆ°å¯¹åº”å¡ç‰‡
      setTimeout(() => {
        const card = document.querySelector(`.radar-card[data-id="${itemId}"]`);
        if (card) {
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // é«˜äº®æ•ˆæœ  
          card.style.boxShadow = '0 0 20px rgba(0, 255, 136, 0.3)';
          setTimeout(() => {
            card.style.boxShadow = '';
          }, 2000);
        }
      }, 300);
    };

    // åˆ·æ–°å½“å‰é¡µé¢
    window.refreshCurrentPage = async function () {
      const activeTab = document.querySelector('.tab-item.active')?.dataset.tab;
      if (activeTab === 'today') {
        await loadToday();
      } else if (activeTab === 'history') {
        await loadHistory();
      }
    };

    // å·¦å³æ»‘åŠ¨æ¢é¡µ
    let touchStartX = 0;
    let touchEndX = 0;
    const swipeThreshold = 100;
    const tabs = ['today', 'history', 'profile'];

    document.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    });

    document.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].clientX;
      handleSwipe();
    });

    function handleSwipe() {
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) < swipeThreshold) return;

      const currentTab = document.querySelector('.tab-item.active')?.dataset.tab;
      const currentIndex = tabs.indexOf(currentTab);

      let newIndex;
      if (diff > 0) {
        // å‘å·¦æ»‘ï¼Œä¸‹ä¸€é¡µ
        newIndex = Math.min(currentIndex + 1, tabs.length - 1);
      } else {
        // å‘å³æ»‘ï¼Œä¸Šä¸€é¡µ
        newIndex = Math.max(currentIndex - 1, 0);
      }

      if (newIndex !== currentIndex) {
        const newTab = document.querySelector(`[data-tab="${tabs[newIndex]}"]`);
        if (newTab) newTab.click();
      }
    }

    // Profileå­æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.profile-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const type = tab.dataset.type;

        // æ›´æ–°æ ‡ç­¾çŠ¶æ€
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // æ˜¾ç¤ºå¯¹åº”å†…å®¹
        document.querySelectorAll('.profile-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`profile-${type}`).classList.add('active');
      });
    });

    // åˆå§‹åŒ–
    setCurrentDate();
    loadToday();
  </script>
</body>

</html>