<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>æ€æƒ³é›·è¾¾ - Thoughts Radar</title>
  <style>
    :root {
      /* ä¸»é¢˜è‰² - å®Œå…¨åŒ¹é…ç§»åŠ¨ç«¯è®¾è®¡ */
      --primary: #00ff88;
      --background: #08090c;
      --card: #12151a;
      --card-hover: #1a1d24;
      --card-border: rgba(0, 255, 136, 0.1);

      /* æ–‡æœ¬ */
      --text: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;

      /* è¾¹æ¡† */
      --border: #1f2937;
      --border-light: #374151;

      /* ç«‹åœºé¢œè‰² */
      --side-a: #4a9eff;
      --side-b: #f0a500;

      /* çŠ¶æ€ */
      --success: #00ff88;
      --warning: #f59e0b;
      --error: #ef4444;

      /* é¢†åŸŸé¢œè‰² */
      --domain-tech: #4a9eff;
      --domain-politics: #ef4444;
      --domain-history: #8b5cf6;
      --domain-philosophy: #ec4899;
      --domain-religion: #f59e0b;
      --domain-finance: #10b981;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* === å¤´éƒ¨ === */
    header {
      background: var(--background);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-size: 32px;
    }

    .title-group h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.2;
    }

    .title-group .subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .date {
      font-size: 15px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* === è¿‡æ»¤å™¨ === */
    .filters-container {
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .filters-container::-webkit-scrollbar {
      display: none;
    }

    .filters {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      min-width: max-content;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-btn:hover {
      border-color: var(--border-light);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--background);
      font-weight: 700;
    }

    /* === ä¸»å†…å®¹åŒº === */
    main {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 80px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* === é›·è¾¾å¡ç‰‡ === */
    .radar-list {
      padding: 16px;
    }

    .radar-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--card-border);
    }

    /* æ ‡ç­¾åŒº */
    .card-tags {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tag {
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid;
    }

    /* æ ‡é¢˜ */
    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    /* ä½œè€…ä¿¡æ¯ */
    .author-info {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0, 255, 136, 0.1);
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
    }

    .author-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    .author-bio {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* æ¥æº */
    .source-line {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .source-bar {
      width: 3px;
      height: 100%;
      min-height: 16px;
      background: var(--primary);
      margin-right: 8px;
      border-radius: 2px;
    }

    .source-text {
      font-size: 13px;
      color: var(--primary);
    }

    /* æ­£æ–‡å†…å®¹ */
    .card-content {
      font-size: 15px;
      color: var(--text);
      line-height: 1.8;
      margin-bottom: 16px;
    }

    .card-content.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 6;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .expand-btn {
      font-size: 13px;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      margin-top: 8px;
      display: inline-block;
    }

    /* å¼ åŠ›ä¿¡æ¯åŒº */
    .tension-box {
      background: var(--background);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .tension-question {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 8px;
    }

    .tension-poles {
      display: flex;
      gap: 12px;
    }

    .pole {
      flex: 1;
    }

    .pole-label {
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .pole-label.side-a {
      color: var(--side-a);
    }

    .pole-label.side-b {
      color: var(--side-b);
    }

    .pole-text {
      font-size: 13px;
      color: var(--text);
    }

    .pole-divider {
      width: 1px;
      background: var(--border);
    }

    /* å…³é”®è¯ */
    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }

    .keyword-tag {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      background: rgba(0, 255, 136, 0.1);
      color: var(--primary);
      border: 1px solid rgba(0, 255, 136, 0.2);
    }

    /* åº•éƒ¨æ“ä½œæ  */
    .card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .like-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      margin: -8px;
    }

    .like-icon {
      font-size: 20px;
    }

    .like-text {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .like-btn.active .like-text {
      color: var(--error);
      font-weight: 500;
    }

    .stance-buttons {
      display: flex;
      gap: 8px;
    }

    .stance-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .stance-btn.side-a:hover {
      border-color: var(--side-a);
      color: var(--side-a);
    }

    .stance-btn.side-b:hover {
      border-color: var(--side-b);
      color: var(--side-b);
    }

    .stance-btn.side-a.active {
      background: var(--side-a);
      border-color: var(--side-a);
      color: var(--text);
      font-weight: 600;
    }

    .stance-btn.side-b.active {
      background: var(--side-b);
      border-color: var(--side-b);
      color: var(--text);
      font-weight: 600;
    }

    /* === TTI é¡µé¢ === */
    .tti-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
    }

    .tti-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--card-border);
    }

    .tti-emoji {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .tti-name {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 4px;
    }

    .tti-value {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--side-a), var(--side-b));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .spectrum-bar {
      height: 6px;
      background: linear-gradient(90deg, var(--side-a), var(--side-b));
      border-radius: 3px;
      margin-top: 12px;
      position: relative;
    }

    .spectrum-indicator {
      position: absolute;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      top: -4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: left 0.3s;
    }

    /* === æˆ‘çš„é¡µé¢ === */
    .profile-section {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin: 16px;
      margin-bottom: 0;
      border: 1px solid var(--card-border);
    }

    .profile-section h3 {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
    }

    .profile-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .profile-item:last-child {
      border-bottom: none;
    }

    /* === ç»Ÿè®¡æ  === */
    .stats-bar {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 8px 16px;
      text-align: center;
      z-index: 50;
    }

    .stats-text {
      font-size: 13px;
      color: var(--primary);
      font-weight: 500;
    }

    /* === Tab Bar === */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      display: flex;
      border-top: 1px solid var(--border);
      z-index: 100;
    }

    .tab-item {
      flex: 1;
      text-align: center;
      padding: 10px 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s;
    }

    .tab-item.active {
      color: var(--primary);
    }

    .tab-item .icon {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .tab-item .label {
      font-size: 12px;
    }

    /* === åŠ è½½çŠ¶æ€ === */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* === å†å²é¡µé¢ === */
    .date-picker {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      overflow-x: auto;
      border-bottom: 1px solid var(--border);
    }

    .date-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .date-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--background);
    }
  </style>
</head>

<body>
  <!-- å¤´éƒ¨ -->
  <header>
    <div class="header-left">
      <span class="logo">ğŸ“¡</span>
      <div class="title-group">
        <h1>æ€æƒ³é›·è¾¾</h1>
        <div class="subtitle">Thoughts Radar</div>
      </div>
    </div>
    <div class="date" id="current-date"></div>
  </header>

  <!-- è¿‡æ»¤å™¨ï¼ˆä»…ä»Šæ—¥é¡µé¢æ˜¾ç¤ºï¼‰ -->
  <div class="filters-container" id="filters-container">
    <div class="filters">
      <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
      <button class="filter-btn" data-filter="tech">ğŸ”¬ ç§‘æŠ€</button>
      <button class="filter-btn" data-filter="politics">ğŸ›ï¸ æ”¿æ²»</button>
      <button class="filter-btn" data-filter="history">ğŸ“š å†å²</button>
      <button class="filter-btn" data-filter="philosophy">ğŸ¤” å“²å­¦</button>
      <button class="filter-btn" data-filter="religion">â›ª å®—æ•™</button>
      <button class="filter-btn" data-filter="finance">ğŸ’° é‡‘è</button>
    </div>
  </div>

  <main>
    <!-- ä»Šæ—¥é›·è¾¾ -->
    <div id="today" class="tab-content active">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- å¼ åŠ›æŒ‡æ•° -->
    <div id="tti" class="tab-content">
      <div class="tti-grid" id="tti-grid"></div>
    </div>

    <!-- å†å² -->
    <div id="history" class="tab-content">
      <div class="date-picker" id="date-picker"></div>
      <div id="history-content" class="radar-list"></div>
    </div>

    <!-- æˆ‘çš„ -->
    <div id="profile" class="tab-content">
      <div class="profile-section">
        <h3>â¤ï¸ æˆ‘çš„æ”¶è—</h3>
        <div id="my-likes" class="empty-state">æš‚æ— æ”¶è—</div>
      </div>
      <div class="profile-section">
        <h3>ğŸ¯ æˆ‘çš„ç«‹åœº</h3>
        <div id="my-stances" class="empty-state">æš‚æ— ç«‹åœº</div>
      </div>
    </div>
  </main>

  <!-- ç»Ÿè®¡æ  -->
  <div class="stats-bar" id="stats-bar" style="display:none;">
    <span class="stats-text" id="stats-text"></span>
  </div>

  <!-- Tab Bar -->
  <nav class="tab-bar">
    <div class="tab-item active" data-tab="today">
      <div class="icon">ğŸ“¡</div>
      <div class="label">ä»Šæ—¥</div>
    </div>
    <div class="tab-item" data-tab="tti">
      <div class="icon">ğŸ“Š</div>
      <div class="label">å¼ åŠ›</div>
    </div>
    <div class="tab-item" data-tab="history">
      <div class="icon">ğŸ“…</div>
      <div class="label">å†å²</div>
    </div>
    <div class="tab-item" data-tab="profile">
      <div class="icon">ğŸ‘¤</div>
      <div class="label">æˆ‘çš„</div>
    </div>
  </nav>

  <script>
    // API é…ç½® - è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000'
      : (window.API_URL || 'https://thoughts-radar-backend-production.up.railway.app');
    const USER_ID = 'web-preview-user-' + Date.now();
    const userLikes = new Set();
    const userStances = {};
    let allItems = [];
    let currentFilter = 'all';

    // é¢†åŸŸé…ç½®
    const DOMAIN_CONFIG = {
      tech: { label: 'ç§‘æŠ€', color: '#4a9eff', icon: 'ğŸ”¬' },
      politics: { label: 'æ”¿æ²»', color: '#ef4444', icon: 'ğŸ›ï¸' },
      history: { label: 'å†å²', color: '#8b5cf6', icon: 'ğŸ“š' },
      philosophy: { label: 'å“²å­¦', color: '#ec4899', icon: 'ğŸ¤”' },
      religion: { label: 'å®—æ•™', color: '#f59e0b', icon: 'â›ª' },
      finance: { label: 'é‡‘è', color: '#10b981', icon: 'ğŸ’°' }
    };

    // è®¾ç½®å½“å‰æ—¥æœŸ
    function setCurrentDate() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      document.getElementById('current-date').textContent = `${y}.${m}.${d}`;
    }

    // Tab åˆ‡æ¢
    document.querySelectorAll('.tab-item').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // æ›´æ–° tab çŠ¶æ€
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tabName).classList.add('active');

        // æ˜¾ç¤º/éšè—è¿‡æ»¤å™¨
        document.getElementById('filters-container').style.display =
          tabName === 'today' ? 'block' : 'none';

        // æ˜¾ç¤º/éšè—ç»Ÿè®¡æ 
        document.getElementById('stats-bar').style.display =
          tabName === 'today' && allItems.length > 0 ? 'block' : 'none';

        // åŠ è½½ç›¸åº”å†…å®¹
        if (tabName === 'tti') loadTTI();
        if (tabName === 'profile') loadProfile();
        if (tabName === 'history') loadHistory();
      });
    });

    // è¿‡æ»¤å™¨åˆ‡æ¢
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderItems();
      });
    });

    // æ¸²æŸ“é›·è¾¾å¡ç‰‡
    function renderRadarCard(item) {
      const domain = DOMAIN_CONFIG[item.domain] || { label: item.domain, color: '#6b7280', icon: 'ğŸ“' };
      const stanceColor = item.stance === 'A' ? 'var(--side-a)' : 'var(--side-b)';
      const isLiked = userLikes.has(item.id);
      const userStance = userStances[item.id];
      const isLong = item.content && item.content.length > 200;

      return `
        <div class="radar-card" data-id="${item.id}">
          <!-- æ ‡ç­¾ -->
          <div class="card-tags">
            <span class="tag" style="background:${domain.color}20; border-color:${domain.color}; color:${domain.color}">
              ${item.freq || domain.label}
            </span>
            <span class="tag" style="background:${stanceColor}20; border-color:${stanceColor}; color:${stanceColor}">
              å€¾å‘${item.stance || 'A'}
            </span>
          </div>
          
          <!-- æ ‡é¢˜ -->
          <div class="card-title">${item.title}</div>
          
          <!-- ä½œè€…ä¿¡æ¯ -->
          ${item.author_name ? `
          <div class="author-info">
            <div class="author-avatar">${item.author_avatar || item.author_name.substring(0, 2)}</div>
            <div>
              <div class="author-name">${item.author_name}</div>
              ${item.author_bio ? `<div class="author-bio">${item.author_bio}</div>` : ''}
            </div>
          </div>
          ` : ''}
          
          <!-- æ¥æº -->
          ${item.source ? `
          <div class="source-line">
            <div class="source-bar"></div>
            <span class="source-text">${item.source}</span>
          </div>
          ` : ''}
          
          <!-- æ­£æ–‡ -->
          <div class="card-content ${isLong ? 'collapsed' : ''}" id="content-${item.id}">
            ${item.content}
          </div>
          ${isLong ? `
          <span class="expand-btn" onclick="toggleExpand(${item.id})">å±•å¼€å…¨æ–‡</span>
          ` : ''}
          
          <!-- å¼ åŠ›ä¿¡æ¯ -->
          <div class="tension-box">
            <div class="tension-question">${item.tension_q || item.band_question || 'æ ¸å¿ƒå¼ åŠ›'}</div>
            <div class="tension-poles">
              <div class="pole">
                <div class="pole-label side-a">Aæ</div>
                <div class="pole-text">${item.tension_a || item.band_side_a || 'è§‚ç‚¹A'}</div>
              </div>
              <div class="pole-divider"></div>
              <div class="pole">
                <div class="pole-label side-b">Bæ</div>
                <div class="pole-text">${item.tension_b || item.band_side_b || 'è§‚ç‚¹B'}</div>
              </div>
            </div>
          </div>
          
          <!-- å…³é”®è¯ -->
          ${(item.keywords && item.keywords.length > 0) ? `
          <div class="keywords">
            ${item.keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
          </div>
          ` : ''}
          
          <!-- æ“ä½œæ  -->
          <div class="card-actions">
            <button class="like-btn ${isLiked ? 'active' : ''}" onclick="toggleLike(${item.id}, this)">
              <span class="like-icon">${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
              <span class="like-text">æ”¶è—</span>
            </button>
            <div class="stance-buttons">
              <button class="stance-btn side-a ${userStance === 'A' ? 'active' : ''}" 
                      onclick="setStance(${item.id}, 'A', this)">
                æˆ‘å€¾å‘A
              </button>
              <button class="stance-btn side-b ${userStance === 'B' ? 'active' : ''}"
                      onclick="setStance(${item.id}, 'B', this)">
                æˆ‘å€¾å‘B
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderItems() {
      const container = document.getElementById('today');
      let filtered = allItems;

      if (currentFilter !== 'all') {
        filtered = allItems.filter(item => item.domain === currentFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="loading">
            <span style="font-size:64px;margin-bottom:16px">ğŸ“­</span>
            <div style="font-size:17px;font-weight:600;margin-bottom:8px">
              ${allItems.length === 0 ? 'ä»Šæ—¥æš‚æ— å†…å®¹' : 'è¯¥é¢†åŸŸæš‚æ— å†…å®¹'}
            </div>
            <div style="font-size:13px;color:#6b7280">ä¸‹æ‹‰åˆ·æ–°æŸ¥çœ‹æœ€æ–°å†…å®¹</div>
          </div>
        `;
        document.getElementById('stats-bar').style.display = 'none';
      } else {
        container.innerHTML = `<div class="radar-list">${filtered.map(renderRadarCard).join('')}</div>`;
        document.getElementById('stats-bar').style.display = 'block';
        const domainLabel = currentFilter !== 'all' ? DOMAIN_CONFIG[currentFilter]?.label : '';
        document.getElementById('stats-text').textContent = `ä»Šæ—¥${domainLabel}å…±${filtered.length}æ¡`;
      }
    }

    // å±•å¼€/æ”¶èµ·
    window.toggleExpand = function (itemId) {
      const content = document.getElementById(`content-${itemId}`);
      const btn = content.nextElementSibling;
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        btn.textContent = 'æ”¶èµ·';
      } else {
        content.classList.add('collapsed');
        btn.textContent = 'å±•å¼€å…¨æ–‡';
      }
    };

    // æ”¶è—
    window.toggleLike = async function (itemId, btn) {
      const isLiked = userLikes.has(itemId);
      try {
        await fetch(`${API_BASE}/api/user/like`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: USER_ID, item_id: itemId, liked: !isLiked })
        });

        if (isLiked) {
          userLikes.delete(itemId);
          btn.classList.remove('active');
          btn.querySelector('.like-icon').textContent = 'ğŸ¤';
        } else {
          userLikes.add(itemId);
          btn.classList.add('active');
          btn.querySelector('.like-icon').textContent = 'â¤ï¸';
        }
      } catch (e) {
        console.error('Like error:', e);
      }
    };

    // ç«‹åœº
    window.setStance = async function (itemId, stance, btn) {
      const currentStance = userStances[itemId];
      const newStance = currentStance === stance ? null : stance;

      try {
        await fetch(`${API_BASE}/api/user/stance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: USER_ID, item_id: itemId, stance: newStance })
        });

        userStances[itemId] = newStance;
        const container = btn.parentElement;
        container.querySelectorAll('.stance-btn').forEach(b => b.classList.remove('active'));
        if (newStance) btn.classList.add('active');
      } catch (e) {
        console.error('Stance error:', e);
      }
    };

    // åŠ è½½ä»Šæ—¥æ•°æ®
    async function loadToday() {
      try {
        const res = await fetch(`${API_BASE}/api/radar/today`);
        const data = await res.json();
        allItems = data.success ? (data.items || []) : [];
        renderItems();
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('today').innerHTML = `
          <div class="loading">
            <span style="font-size:64px;margin-bottom:16px">âš ï¸</span>
            <div style="font-size:17px;font-weight:600;margin-bottom:8px">åŠ è½½å¤±è´¥</div>
            <div style="font-size:13px;color:#6b7280">${e.message}</div>
            <button onclick="loadToday()" style="margin-top:16px;padding:8px 24px;background:#00ff88;border:none;border-radius:20px;font-weight:700;cursor:pointer">é‡è¯•</button>
          </div>
        `;
      }
    }

    // åŠ è½½ TTI
    async function loadTTI() {
      try {
        const res = await fetch(`${API_BASE}/api/bands`);
        const data = await res.json();
        const bands = data.success ? (data.bands || []) : [];

        document.getElementById('tti-grid').innerHTML = bands.map(band => {
          const tti = band.tti || band.tti_index || 50;
          return `
            <div class="tti-card">
              <div class="tti-emoji">${band.emoji || 'ğŸ“Š'}</div>
              <div class="tti-name">${band.question || band.name}</div>
              <div class="tti-value">${tti}</div>
              <div class="spectrum-bar">
                <div class="spectrum-indicator" style="left:calc(${tti}% - 7px)"></div>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Load TTI error:', e);
      }
    }

    // åŠ è½½å†å²
    async function loadHistory() {
      const picker = document.getElementById('date-picker');
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(d.toISOString().split('T')[0]);
      }

      picker.innerHTML = dates.map((date, i) => {
        const d = new Date(date);
        const label = i === 0 ? 'ä»Šå¤©' : i === 1 ? 'æ˜¨å¤©' : `${d.getMonth() + 1}/${d.getDate()}`;
        return `<button class="date-btn ${i === 0 ? 'active' : ''}" data-date="${date}">${label}</button>`;
      }).join('');

      picker.querySelectorAll('.date-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          picker.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadHistoryDate(btn.dataset.date);
        });
      });

      loadHistoryDate(dates[0]);
    }

    async function loadHistoryDate(date) {
      try {
        const res = await fetch(`${API_BASE}/api/radar/${date}`);
        const data = await res.json();
        const items = data.success ? (data.items || []) : [];

        document.getElementById('history-content').innerHTML = items.length > 0
          ? items.map(renderRadarCard).join('')
          : '<div class="empty-state">è¯¥æ—¥æœŸæš‚æ— å†…å®¹</div>';
      } catch (e) {
        console.error('Load history error:', e);
      }
    }

    // åŠ è½½ä¸ªäººä¿¡æ¯
    async function loadProfile() {
      try {
        const [likesRes, stancesRes] = await Promise.all([
          fetch(`${API_BASE}/api/user/${USER_ID}/likes`),
          fetch(`${API_BASE}/api/user/${USER_ID}/stances`)
        ]);

        const likes = await likesRes.json();
        const stances = await stancesRes.json();

        const likesDiv = document.getElementById('my-likes');
        const stancesDiv = document.getElementById('my-stances');

        const likeItems = likes.success ? (likes.items || []) : [];
        const stanceItems = stances.success ? (stances.items || []) : [];

        likesDiv.innerHTML = likeItems.length > 0
          ? likeItems.map(l => `<div class="profile-item">${l.title || 'å†…å®¹ #' + l.item_id}</div>`).join('')
          : '<div class="empty-state">æš‚æ— æ”¶è—</div>';

        stancesDiv.innerHTML = stanceItems.length > 0
          ? stanceItems.map(s => `
              <div class="profile-item">
                ${s.title || 'å†…å®¹ #' + s.item_id}ï¼š
                <span style="color:${s.stance === 'A' ? 'var(--side-a)' : 'var(--side-b)'}">
                  å€¾å‘${s.stance}
                </span>
              </div>
            `).join('')
          : '<div class="empty-state">æš‚æ— ç«‹åœº</div>';
      } catch (e) {
        console.error('Profile error:', e);
      }
    }

    // åˆå§‹åŒ–
    setCurrentDate();
    loadToday();
  </script>
</body>

</html>